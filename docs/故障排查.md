# NagaAgent 故障排查指南

本指南帮助你解决使用 NagaAgent 时遇到的问题。

---

## 📋 目录

1. [安装问题](#安装问题)
2. [启动问题](#启动问题)
3. [连接问题](#连接问题)
4. [功能问题](#功能问题)
5. [性能问题](#性能问题)

---

## 安装问题

### 1. Python 版本不兼容

**现象**：提示 Python 版本错误或依赖安装失败

**解决**：
1. 确认 Python 版本为 3.11
   ```bash
   python --version
   ```

2. 如果版本不对，下载 Python 3.11 并安装

3. 使用国内镜像源安装依赖
   ```bash
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```

### 2. 依赖安装失败

**现象**：`pip install` 报错

**解决**：
1. 升级 pip
   ```bash
   python -m pip install --upgrade pip
   ```

2. 使用 uv 安装（更快）
   ```bash
   pip install uv
   uv sync
   ```

3. 逐个安装依赖，查看具体错误
   ```bash
   pip install package_name --verbose
   ```

### 3. 虚拟环境问题

**现象**：导入模块失败

**解决**：
1. 重新创建虚拟环境
   ```bash
   # 删除旧环境
   rm -rf .venv

   # 创建新环境
   python -m venv .venv

   # 激活环境
   # Windows
   .\.venv\Scripts\activate
   # Linux/Mac
   source .venv/bin/activate

   # 安装依赖
   pip install -r requirements.txt
   ```

---

## 启动问题

### 1. 端口被占用

**现象**：启动时提示端口已被占用

**解决**：
1. 查找占用端口的进程
   ```bash
   # Windows
   netstat -ano | findstr :8000

   # Linux/Mac
   lsof -i :8000
   ```

2. 结束占用进程或修改 `config.json` 中的端口号

3. 端口说明：
   - 8000 - API 服务器
   - 8001 - Agent 服务器
   - 8003 - MCP 服务器
   - 5048 - TTS 服务器

### 2. 系统环境检测失败

**现象**：提示环境检测不通过

**解决**：
1. 查看具体检测失败的项目
2. 根据提示安装缺失的依赖
3. 或者选择强制启动（不推荐）

### 3. 服务启动失败

**现象**：某个服务无法启动

**解决**：
1. 查看启动日志中的错误信息
2. 检查端口是否被占用
3. 检查配置文件是否正确

---

## 连接问题

### 1. QQ 机器人连接失败

**现象**：提示 HTTP 403 或连接超时

**解决**：
1. 确认 NapCat 正在运行
   ```bash
   # 检查 NapCat 是否在运行
   curl http://127.0.0.1:3000
   ```

2. 检查 `config.json` 中的配置
   - `http_url` 是否正确
   - `bot_qq` 是否正确
   - `http_token` 和 `ws_token` 是否与 NapCat 配置一致

3. 如果使用 Token，清空 `config.json` 中的 `http_token` 和 `ws_token` 试试

### 2. 微信机器人无法登录

**现象**：二维码无法显示或登录失败

**解决**：
1. 确认 `config.json` 中 `wechat.enabled` 为 `true`
2. 确认 `enable_login_qrcode` 为 `true`
3. 检查微信账号是否被封禁
4. 尝试重新启动程序

### 3. GPT-SoVITS 连接失败

**现象**：语音功能无法使用，提示 HTTP 404

**解决**：
1. 启动 GPT-SoVITS 服务
   ```bash
   cd GPT-SoVITS目录
   python api_v2.py
   ```

2. 确认服务地址正确
   ```bash
   curl http://127.0.0.1:9880
   ```

3. 检查 `config.json` 中的 `gpt_sovits_url` 配置

### 4. Neo4j 连接失败

**现象**：记忆系统无法使用

**解决**：
1. 确认 Neo4j 服务正在运行
   ```bash
   # Windows
   netstat -ano | findstr :7687

   # Linux/Mac
   lsof -i :7687
   ```

2. 检查连接参数是否正确
   ```json
   {
     "grag": {
       "neo4j_uri": "neo4j://127.0.0.1:7687",
       "neo4j_user": "neo4j",
       "neo4j_password": "your_password"
     }
   }
   ```

3. 如果一直失败，可以暂时禁用 GRAG 功能
   ```json
   {
     "grag": {
       "enabled": false
     }
   }
   ```

### 5. 移动端无法访问

**现象**：手机无法访问 Web 界面

**解决**：
1. 确认 `config.json` 中 `api_server.host` 为 `"0.0.0.0"`
2. 配置防火墙允许端口 8000
3. 确认手机和电脑在同一 Wi-Fi 网络
4. 检查电脑 IP 地址是否正确

---

## 功能问题

### 1. AI 不回复

**现象**：发送消息后没有回复

**解决**：
1. 检查 API 密钥是否有效
2. 检查 API 账户余额是否充足
3. 查看 `logs/` 目录下的日志文件
4. 检查网络连接是否正常

### 2. 语音无法播放

**现象**：AI 有回复但没有语音

**解决**：
1. 确认已启用语音功能
   ```json
   {
     "system": {
       "voice_enabled": true
     }
   }
   ```

2. 确认 TTS 服务正在运行
   ```bash
   curl http://127.0.0.1:5048
   ```

3. 检查 `reply_mode` 配置是否包含语音
   ```json
   {
     "reply_mode": "voice"  // 或 "both"
   }
   ```

### 3. 群聊不回复

**现象**：群聊中 AI 不回复

**解决**：
1. 检查 `enable_group_reply` 是否启用
   ```json
   {
     "enable_group_reply": true
   }
   ```

2. 检查 `group_reply_mode` 配置
   - `at_only` - 只回复@机器人的消息
   - `intelligent` - 智能判断
   - `all` - 回复所有消息

3. 检查群是否在黑名单中
4. 检查是否在白名单中（如果设置了白名单）

### 4. 工具调用失败

**现象**：AI 无法调用工具

**解决**：
1. 检查 MCP 服务是否正常运行
   ```bash
   curl http://127.0.0.1:8003
   ```

2. 检查工具是否被禁用
3. 查看日志文件了解具体错误

---

## 性能问题

### 1. 响应速度慢

**现象**：AI 回复速度很慢

**解决**：
1. 检查网络连接是否稳定
2. 尝试使用更快的 LLM（如 DeepSeek）
3. 减少 `max_tokens` 参数
4. 降低 `temperature` 参数

### 2. 内存占用高

**现象**：程序占用大量内存

**解决**：
1. 禁用不必要的功能（如 Neo4j、Live2D）
2. 减少对话历史长度
3. 定期清理缓存

### 3. CPU 占用高

**现象**：程序占用大量 CPU

**解决**：
1. 检查是否有死循环
2. 禁用不必要的后台服务
3. 减少并发任务数量

---

## 日志分析

### 查看日志

日志存储在 `logs/` 目录下：

```bash
# Windows
type logs\nagaagent.log

# Linux/Mac
tail -f logs/nagaagent.log
```

### 常见日志错误

| 错误信息 | 可能原因 | 解决方法 |
|----------|----------|----------|
| `Connection refused` | 服务未启动 | 启动对应服务 |
| `Authentication failed` | API 密钥错误 | 检查 API Key |
| `Timeout` | 网络超时 | 检查网络连接 |
| `Port already in use` | 端口被占用 | 修改端口或结束占用进程 |

---

## 获取帮助

如果以上方法无法解决你的问题：

1. 查看 [常见问题](./常见问题.md)
2. 查看 GitHub Issues
3. 提交新的 Issue，附上：
   - 问题描述
   - 错误日志
   - 系统信息（OS、Python 版本）
   - 配置文件（敏感信息已删除）

---

## 📚 相关文档

- [快速开始](./快速开始.md)
- [功能使用指南](./功能指南.md)
- [配置指南](./配置指南/配置总览.md)
- [常见问题](./常见问题.md)
