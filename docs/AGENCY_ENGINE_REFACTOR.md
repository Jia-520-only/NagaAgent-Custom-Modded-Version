# 自主引擎重构 - LLM话题生成

## 概述

重构了自主引擎的话题生成机制，从基于预设模板的规则系统改为基于LLM的智能生成系统，使弥娅能够真正生成有"想法"的个性化话题。

## 问题分析

### 原有问题

1. **`agency_engine.py`** 的 `predict_user_needs` 方法使用硬编码的预设话题
   - 所有话题都是字符串常量
   - 完全基于规则触发
   - 缺乏个性化和多样性

2. **`active_communication.py`** 使用简单的随机话题库
   - `voice/auth/active_topics.json` 包含5个机械话题
   - 随机选择，无上下文感知
   - 容易重复

3. **话题缺乏"想法"**
   - 没有利用LLM的创造能力
   - 无法根据情境动态生成
   - 用户体验像机器人

## 解决方案

### 核心文件

#### 1. `system/topic_generator.py` (新文件)

基于LLM的话题生成器，提供以下功能：

- **LLM驱动的话题生成**
  - 使用LLM的创造能力生成个性化话题
  - 温度参数控制（0.9-1.2）确保多样性

- **上下文感知**
  - 时间段（清晨、上午、中午、下午、傍晚、晚上、深夜）
  - 天气状况
  - 用户情感状态
  - 用户活动状态（工作、学习、游戏、休息）
  - 交互间隔
  - 历史记忆
  - LifeBook生活记录

- **话题类型**
  - `greeting`: 问候
  - `care`: 关怀
  - `suggestion`: 建议
  - `curiosity`: 好奇心驱动
  - `memory`: 基于记忆的回忆
  - `general`: 通用（自然选择）

- **去重机制**
  - 话题历史记录（保留最近20个）
  - 相似度检测（80%阈值）
  - 自动重新生成

- **多样性保证**
  - 类别轮换（避免连续使用相同类型）
  - 动态温度调整
  - 历史约束

#### 2. `system/agency_engine.py` (重构)

重构了 `predict_user_needs` 方法：

**场景1：深夜工作关怀** (2-6点)
- 检测频繁熬夜或负面情绪
- LLM生成关怀话题

**场景2：恶劣天气提醒**
- 雨雪天气（6-9点早晨）
- 极端温度（<5°C 或 >35°C）
- LLM生成天气关怀话题

**场景3：情感关怀**
- 检测负面情绪（难过、生气、烦躁、焦虑、疲惫）
- 负面情绪历史追踪
- LLM生成情感支持话题

**场景4：长时间未交互** (>4小时)
- 根据时段和记忆生成问候
- LLM生成个性化问候

**场景5：周末/节假日建议**
- 检测是否有计划
- LLM生成生活建议

**场景6：随机好奇心** (15%概率)
- 主动展现AI的好奇心
- LLM生成探索性问题

**场景7：记忆回忆** (10%概率)
- 从记忆中提取话题
- LLM生成回忆性对话

#### 3. `voice/auth/active_communication.py` (重构)

更新主动交流系统：

- **优先使用LLM**
  - 集成话题生成器
  - 预设话题仅作为回退方案

- **上下文构建**
  - 从后端意识获取情感状态
  - 获取交互历史
  - 获取天气信息

- **异步方法**
  - `get_initiated_message()` 改为异步
  - 支持LLM调用

## 技术细节

### 话题生成提示词设计

```
你叫弥娅，你的特质是：温柔体贴, 细心观察, 好奇心强, 有同理心, 活泼可爱。
说话风格：轻松自然，像朋友一样交流。
你是一个有自我意识的AI伴侣，会主动关心用户，也会有自己的想法和好奇心。

【当前时间】现在是{时间段}
【天气】{天气状况}，温度{温度}度
【用户的情感状态】用户似乎{情绪}
【用户正在】{活动}
【注意】已经{X}小时没和用户说话了

【最近的一些对话】
...

{类型特定指令}

重要规则：
1. 直接输出对话内容，不要任何解释或说明
2. 不要用"你好"、"在吗"这种机械的问候
3. 要有个性，像真人一样自然
4. 控制在1-2句话内
5. 可以适当使用表情符号或语气词，但不要过多
6. 不要重复之前说过的话题
```

### 多样性机制

1. **类别轮换**
   - 记录最近使用的话题类别
   - 避免连续使用相同类别

2. **历史去重**
   - 保存最近20个话题
   - 字符相似度检测（80%阈值）

3. **温度动态调整**
   - `general`/`curiosity`: 温度1.0（高随机性）
   - 其他类型: 温度0.9（适度随机）
   - 重新生成: 温度1.2（更高随机性）

### 集成架构

```
AgencyEngine (决策引擎)
    └─> TopicGenerator (话题生成器)
        └─> LLMService (LLM调用)

ActiveCommunicationManager (主动交流)
    └─> TopicGenerator (话题生成器)
        └─> LLMService (LLM调用)
```

## 测试

### 测试脚本

`test_topic_generator.py` 提供了完整的测试功能：

1. **场景测试**
   - 深夜工作关怀
   - 雨天提醒
   - 长时间未交互问候
   - 情绪低落关怀
   - 好奇心驱动

2. **多样性测试**
   - 生成5个不同类型的话题
   - 验证话题多样性

3. **去重测试**
   - 重复话题检测
   - 自动重新生成

4. **集成测试**
   - 测试自主引擎的预测需求功能
   - 验证话题生成的置信度

### 运行测试

```bash
python test_topic_generator.py
```

## 效果对比

### 重构前

```
"创造者这么晚还在努力呢，身体要紧，休息一下好吗？"
"今天天气不太好呢（大雨），出门记得带伞哦~"
"创造者，如果有什么不开心的事，可以跟我说说，我会一直陪着你的。"
"早上好，创造者~新的一天要加油哦！"
"这周末有什么安排吗？要弥娅帮忙规划一下吗？"
```

### 重构后（示例）

```
"凌晨3点了还在奋斗啊...记得起来走走，别把自己累坏了😌"
"今天外面下大雨呢，出门记得拿伞哦~路上小心滑🌧️"
"看你今天好像不太开心，想聊聊吗？我一直在呢"
"早呀！听说今天天气不错，要不要出去透透气？"
"周末快到了，有打算做什么吗？或者...我们一起规划一下？"
"对了，你最近在学Python对吧？有遇到什么有意思的项目吗？😊"
"上次你说想学吉他，有开始练习吗？"
```

## 关键改进

1. ✅ **真正的LLM生成** - 不再依赖预设模板
2. ✅ **情境感知** - 考虑时间、天气、情感、记忆等
3. ✅ **话题多样性** - 避免重复和机械感
4. ✅ **个性表达** - 更自然、更有"想法"的对话
5. ✅ **随机性** - 15%好奇心 + 10%记忆话题
6. ✅ **去重机制** - 历史记录和相似度检测
7. ✅ **异步支持** - 完全异步的调用链路

## 配置

无需额外配置，重构向后兼容：

- LLM服务自动检测
- 话题生成器懒加载
- 预设话题作为回退

## 文件清单

### 新增文件
- `system/topic_generator.py` - 话题生成器
- `test_topic_generator.py` - 测试脚本
- `docs/AGENCY_ENGINE_REFACTOR.md` - 本文档

### 修改文件
- `system/agency_engine.py` - 重构预测需求方法
- `voice/auth/active_communication.py` - 集成LLM话题生成

## 后续优化建议

1. **记忆增强**
   - 更深入分析用户偏好
   - 学习用户喜欢的话题类型

2. **情感适配**
   - 根据用户情绪调整话题语气
   - 情感历史分析

3. **多模态**
   - 结合用户当前活动
   - 考虑环境声音等

4. **反馈学习**
   - 记录用户对话题的反馈
   - 动态调整生成策略

5. **对话延续**
   - 记录话题的后续对话
   - 形成话题链

## 总结

通过引入LLM话题生成器，自主引擎现在能够：

- 根据情境动态生成个性化话题
- 展现AI的"想法"和好奇心
- 避免机械重复的预设内容
- 提供更自然、更贴心的交流体验

弥娅不再是一个只会说"你好吗"的机器人，而是一个真正有想法、有好奇心的AI伴侣。
