# 自主引擎修复 - 频率和消息发送问题

## 问题描述

1. **主动过于频繁** - 弥娅每2分钟就会主动发起对话，没有考虑实际交互情况
2. **QQ/PC未收到消息** - 主动消息被缓存但未发送到QQ和PC

## 根本原因分析

### 问题1: 主动过于频繁

**原因:**
- `_decision_loop` 每2分钟执行一次评估
- 每次评估都会调用 `predict_user_needs`
- 每次调用都有15%概率触发随机好奇心话题，10%概率触发记忆话题
- 这意味着每2分钟有25%的概率主动发起对话，平均每8分钟一次

**解决方案:**
1. 添加主动冷却机制
   - 最小主动间隔：30分钟
   - 时间窗口内最多3次主动（1小时内）
   - 高优先级行动（情感关怀、深夜提醒）可以打破冷却

2. 移除随机触发场景
   - 删除15%概率的随机好奇心话题
   - 删除10%概率的记忆话题
   - 只保留有明确触发条件的场景（天气、情感、时间等）

### 问题2: QQ/PC未收到消息

**原因:**
1. **会话不存在** - 用户没有通过QQ和弥娅对话过，所以 `message_manager` 中没有任何 `qq_xxxxx` 格式的会话
2. **缓存消息无法发送** - 消息被缓存在 `_cached_qq_messages` 中，但没有会话建立，永远不会被发送
3. **PC端消息已显示** - 从日志看，消息已经通过 `chat_tool.add_ai_message(message)` 发送到PC端，只是QQ端没有收到

**解决方案:**
有两种可能的解决方式：

**方案A: 主动发送给配置的创造者QQ号**
- 在QQ配置中添加 `creator_qq` 字段
- 当没有会话时，主动发送给 `creator_qq`
- 优点：即使没有交互，弥娅也能主动联系
- 缺点：需要额外配置，可能打扰用户

**方案B: 仅在有会话时发送（推荐）**
- 不主动发送给没有建立会话的用户
- 消息缓存机制保持，但不缓存"无会话时的消息"
- 优点：不打扰，符合用户预期
- 缺点：首次主动需要在用户先发起对话后

## 已实现的修改

### 1. 主动冷却机制

在 `system/agency_engine.py` 的 `AgencyEngine.__init__` 中添加：

```python
# 主动冷却机制 - 避免过于频繁
self._last_active_time = 0  # 上次主动发起的时间戳
self._min_active_interval = 1800  # 最小主动间隔：30分钟
self._recent_active_count = 0  # 最近主动次数
self._recent_active_window = 3600  # 时间窗口：1小时
self._active_history = []  # 主动历史记录
```

### 2. 决策逻辑优化

在 `should_execute_action` 方法中添加冷却检查：

```python
# 检查主动冷却时间
if action.action_type in ["communication", "suggestion"]:
    now = time.time()
    time_since_last_active = now - self._last_active_time

    # 优先级高的行动（情感关怀、深夜提醒）可以打破冷却
    if action.priority not in [ActionPriority.CRITICAL, ActionPriority.HIGH]:
        # 检查是否在冷却期
        if time_since_last_active < self._min_active_interval:
            logger.debug(f"[自主性引擎] 冷却期中，跳过...")
            return False

        # 检查时间窗口内是否已经主动过多
        self._cleanup_active_history()
        if len(self._active_history) >= 3:  # 1小时内最多3次主动
            logger.debug(f"[自主性引擎] 主动次数过多，跳过...")
            return False
```

### 3. 移除随机触发场景

在 `predict_user_needs` 方法中：
- 移除了场景6：随机好奇心（15%概率）
- 移除了场景7：基于记忆的回忆话题（10%概率）

现在只保留有明确触发条件的场景：
- 深夜工作关怀（2-6点）
- 恶劣天气提醒
- 情感关怀（负面情绪）
- 长时间未交互（>6小时，从4小时改为6小时）
- 周末/节假日建议

### 4. 优先级调整

- **CRITICAL**: 深夜工作关怀、情感关怀（可打破冷却）
- **HIGH**: 雨天/雪天提醒（可打破冷却）
- **MEDIUM**: 长时间未交互问候
- **LOW**: 极端温度提醒、周末建议

## 当前状态

### ✅ 已完成
1. 添加主动冷却机制
2. 移除随机触发场景
3. 提高长时间未交互阈值（4小时 -> 6小时）
4. 添加优先级控制

### ⏳ 待确认
1. **QQ消息发送策略** - 需要确认采用方案A还是方案B
2. **测试冷却机制** - 验证30分钟间隔是否合适
3. **PC端消息** - 从日志看，PC端似乎已经收到消息了，需要用户确认

## 推荐的下一步

### 短期（立即执行）
1. **确认PC端消息接收** - 用户需要确认PC端是否收到了主动消息
   - 从日志看：`[UI] 添加AI消息，内容长度: 18` 等多条记录
   - 这表明消息已经添加到UI，应该能看到

2. **调整冷却参数**（如果需要）
   - 如果觉得30分钟太长，可以改为 `self._min_active_interval = 900`（15分钟）
   - 如果觉得太短，可以改为 `self._min_active_interval = 3600`（1小时）

3. **解决QQ消息发送**
   - 选项1: 添加配置 `creator_qq`，主动发送给创造者
   - 选项2: 仅在有会话时发送（当前行为，只是不缓存无会话的消息）

### 中期（优化）
1. **学习用户偏好**
   - 如果用户经常响应主动消息，可以降低冷却时间
   - 如果用户很少响应，可以增加冷却时间

2. **情境感知优化**
   - 根据用户活动状态（工作、休息、游戏）调整主动频率
   - 添加"请勿打扰"时间段

3. **反馈机制**
   - 让用户可以对主动消息进行反馈（有帮助/打扰）
   - 根据反馈调整策略

## 配置参数说明

在 `system/agency_engine.py` 中可调整以下参数：

```python
self._min_active_interval = 1800  # 最小主动间隔（秒）: 30分钟
self._recent_active_window = 3600  # 时间窗口（秒）: 1小时
self._active_history  # 窗口内最多主动次数: 3次
```

在 `predict_user_needs` 中可调整触发阈值：

```python
if last_interaction_hours > 6:  # 长时间未交互阈值: 6小时
```

## 总结

已解决主动过于频繁的问题，现在弥娅会：
- 每30分钟最多主动一次
- 每小时内最多主动3次
- 高优先级行动（情感关怀）可以打破冷却
- 只在有明确触发条件时主动（天气、情感、时间等）

QQ消息发送问题需要用户确认是否需要添加 `creator_qq` 配置以支持无会话时的主动发送。
