# Undefined 项目完整学习路径

> 这是一个从零开始学习Python并通过这个项目精通编程的完整指南

---

## 📋 学习路线图

```
阶段1: 项目整体架构 ✅
  ├─ 理解项目是做什么的
  ├─ 了解启动流程
  ├─ 理解模块化设计
  └─ Python基础回顾

阶段2: 配置系统 ✅
  ├─ TOML配置格式
  ├─ dataclass数据类
  ├─ 配置加载器
  └─ 热更新机制

阶段3: AI运行时 🔄 进行中
  ├─ AIClient核心架构
  ├─ OpenAI API调用
  ├─ 工具调用机制
  └─ Agent系统

阶段4: 消息处理 ⏳
  ├─ OneBot协议
  ├─ WebSocket连接
  ├─ 消息处理器
  └─ 命令分发

阶段5: Skills技能系统 ⏳
  ├─ 工具注册机制
  ├─ 工具开发
  ├─ Agent开发
  └─ 可调用配置

阶段6: 存储系统 ⏳
  ├─ 聊天历史
  ├─ 记忆存储
  ├─ FAQ存储
  └─ Token统计

阶段7: 工具和辅助 ⏳
  ├─ 文件IO
  ├─ 日志系统
  ├─ B站视频处理
  └─ 其他工具

阶段8: 最佳实践 ⏳
  ├─ Python进阶特性
  ├─ 代码组织
  ├─ 性能优化
  └─ 总结
```

---

## 🚀 快速开始指南

### 第一步: 理解程序如何运行

**入口点** - `src/Undefined/__main__.py`
```python
from Undefined.main import run

if __name__ == "__main__":
    run()
```

**主函数** - `src/Undefined/main.py`
```python
def run() -> None:
    """运行入口"""
    asyncio.run(main())  # 启动异步事件循环

async def main() -> None:
    """主函数"""
    setup_logging()       # 1. 设置日志
    ensure_runtime_dirs() # 2. 创建目录
    config = get_config() # 3. 加载配置

    # 4. 初始化组件
    onebot = OneBotClient(...)
    ai = AIClient(...)
    handler = MessageHandler(...)

    # 5. 启动运行
    await onebot.run_with_reconnect()
```

### 第二步: 理解配置系统

**配置文件位置**: `config.toml`

**读取配置**: `config/loader.py`
```python
@dataclass
class ChatModelConfig:
    api_url: str
    api_key: str
    model_name: str
    max_tokens: int
```

**使用配置**:
```python
config = get_config()
print(f"机器人QQ: {config.bot_qq}")
print(f"API地址: {config.chat_model.api_url}")
```

### 第三步: 理解AI客户端

**AI客户端**: `ai/client.py`
```python
class AIClient:
    def __init__(self, chat_config, vision_config, agent_config, ...):
        self.tool_registry = ToolRegistry(...)      # 工具注册表
        self.agent_registry = AgentRegistry(...)    # Agent注册表
        self._requester = ModelRequester(...)      # API请求器
        self.tool_manager = ToolManager(...)       # 工具管理器
```

### 第四步: 理解消息处理

**消息处理器**: `handlers.py`
```python
class MessageHandler:
    async def handle_message(self, event):
        # 1. 检查是否是命令
        if is_command(event):
            await self.command_dispatcher.handle(event)
            return

        # 2. 安全检查
        if not self.security.is_safe(event):
            return

        # 3. 发送给AI处理
        await self.ai.process_message(event)
```

### 第五步: 理解工具系统

**工具定义**: `skills/tools/`
```python
from Undefined.skills.tools import Tool

@tool
def get_current_time() -> str:
    """获取当前时间"""
    from datetime import datetime
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")
```

**Agent定义**: `skills/agents/`
```python
from Undefined.skills.agents import Agent

@agent(
    name="search_agent",
    description="网络搜索助手",
    tools=["web_search", "crawl_webpage"]
)
class SearchAgent:
    pass
```

---

## 💡 Python知识点速查

### 1. 异步编程

```python
# 定义异步函数
async def my_function():
    result = await some_async_operation()
    return result

# 运行异步函数
asyncio.run(my_function())

# 并发执行
await asyncio.gather(task1(), task2(), task3())
```

### 2. 类和对象

```python
class MyClass:
    def __init__(self, name: str):
        self.name = name  # 实例变量

    def method(self) -> str:
        return f"Hello, {self.name}"

obj = MyClass("World")
print(obj.method())  # Hello, World
```

### 3. dataclass

```python
from dataclasses import dataclass

@dataclass
class Person:
    name: str
    age: int
    email: str = "unknown@example.com"

person = Person(name="小明", age=18)
print(person.name)  # 小明
```

### 4. 类型提示

```python
def add(a: int, b: int) -> int:
    return a + b

def process(items: list[str]) -> dict[str, int]:
    return {item: len(item) for item in items}

def get_user(id: int) -> dict[str, str] | None:
    if id == 0:
        return None
    return {"id": str(id), "name": "Test"}
```

### 5. 错误处理

```python
try:
    result = risky_operation()
except ValueError as e:
    print(f"值错误: {e}")
except Exception as e:
    print(f"其他错误: {e}")
finally:
    cleanup()
```

### 6. 上下文管理器

```python
import contextvars

request_id = contextvars.ContextVar("request_id")

async def process_request():
    request_id.set("req_123")
    print(f"当前请求: {request_id.get()}")
```

---

## 📦 核心模块详解

### 模块1: main.py - 程序入口

**关键代码**:
```python
async def main() -> None:
    # 步骤1: 设置日志
    setup_logging()

    # 步骤2: 创建目录
    ensure_runtime_dirs()

    # 步骤3: 加载配置
    config = get_config()

    # 步骤4: 初始化组件
    onebot = OneBotClient(...)
    ai = AIClient(...)
    handler = MessageHandler(...)

    # 步骤5: 启动热更新
    config_manager.start_hot_reload()

    # 步骤6: 运行
    await onebot.run_with_reconnect()
```

### 模块2: config/ - 配置系统

**文件结构**:
```
config/
├── loader.py      # 配置加载器
├── manager.py     # 配置管理器
├── models.py      # 配置数据模型
└── hot_reload.py  # 热更新逻辑
```

**使用示例**:
```python
from Undefined.config import get_config

config = get_config()

# 访问配置
bot_qq = config.bot_qq
api_url = config.chat_model.api_url
api_key = config.chat_model.api_key
```

### 模块3: ai/ - AI运行时

**文件结构**:
```
ai/
├── client.py      # AI客户端主入口
├── llm.py         # LLM请求器
├── prompts.py     # 提示词构建器
├── tooling.py     # 工具管理器
├── multimodal.py  # 多模态分析器
└── tokens.py      # Token计数器
```

**核心流程**:
```
用户消息
    ↓
PromptBuilder 构建提示词
    ↓
注入历史消息、记忆、知识库
    ↓
ModelRequester 调用AI API
    ↓
AI返回回复 + 工具调用
    ↓
ToolManager 执行工具
    ↓
返回最终结果
```

### 模块4: onebot.py - QQ协议

**核心类**:
```python
class OneBotClient:
    async def connect(self):
        """连接WebSocket"""
        self.ws = await websockets.connect(self.ws_url)

    async def send_message(self, user_id, message):
        """发送消息"""
        await self._call_api("send_msg", {
            "user_id": user_id,
            "message": message
        })
```

### 模块5: handlers.py - 消息处理

**处理流程**:
```python
async def handle_message(self, event):
    # 1. 检查命令
    if is_command(event):
        await self.command_dispatcher.handle(event)
        return

    # 2. 安全检查
    if not await self.security.is_safe(event):
        return

    # 3. 保存历史
    await self.history_manager.save(event)

    # 4. AI处理
    await self.ai_coordinator.coordinate(event)
```

### 模块6: skills/ - 技能系统

**目录结构**:
```
skills/
├── tools/        # 基础工具
│   ├── get_current_time.py
│   ├── python_interpreter.py
│   └── ...
├── toolsets/     # 工具集
│   ├── messages/
│   ├── memory/
│   └── ...
├── agents/       # 智能体
│   ├── search_agent/
│   ├── code_agent/
│   └── ...
└── anthropic_skills/  # Anthropic Skills
```

**工具示例**:
```python
from Undefined.skills.tools import Tool

@tool
def calculate(expression: str) -> str:
    """计算数学表达式"""
    try:
        result = eval(expression)
        return str(result)
    except Exception as e:
        return f"计算错误: {e}"
```

---

## 🎮 实战练习

### 练习1: 修改配置

1. 复制 `config.toml.example` 为 `config.toml`
2. 填写你的QQ号和管理员QQ号
3. 配置API密钥
4. 运行程序,观察日志

### 练习2: 添加一个简单工具

创建文件: `skills/tools/my_tool.py`
```python
from Undefined.skills.tools import Tool

@tool
def say_hello(name: str = "世界") -> str:
    """打招呼工具

    Args:
        name: 要打招呼的名字

    Returns:
        打招呼的消息
    """
    return f"你好, {name}!"
```

### 练习3: 理解异步编程

创建文件: `async_demo.py`
```python
import asyncio

async def task1():
    print("任务1开始")
    await asyncio.sleep(2)
    print("任务1完成")

async def task2():
    print("任务2开始")
    await asyncio.sleep(1)
    print("任务2完成")

async def main():
    # 串行执行
    await task1()
    await task2()

    # 并行执行
    await asyncio.gather(task1(), task2())

asyncio.run(main())
```

---

## 📚 学习资源

### 项目文档
- `README.md` - 项目介绍
- `ARCHITECTURE.md` - 架构文档
- `src/Undefined/skills/README.md` - 技能系统文档

### Python官方文档
- Python基础: https://docs.python.org/zh-cn/3/tutorial/
- 异步编程: https://docs.python.org/zh-cn/3/library/asyncio.html

### 推荐书籍
- 《流畅的Python》
- 《Python编程从入门到实践》

---

## 🎯 学习建议

### 1. 循序渐进
- 先理解整体流程
- 再深入每个模块
- 最后动手实践

### 2. 动手实验
- 修改代码观察变化
- 添加新功能
- 阅读错误信息

### 3. 使用工具
- IDE代码跳转
- 调试器
- 日志输出

### 4. 查阅文档
- 项目注释
- 官方文档
- README

---

## ✅ 学习检查清单

### 阶段1: 项目基础
- [ ] 理解项目是做什么的
- [ ] 知道程序如何启动
- [ ] 理解模块化设计
- [ ] 会使用Python基础语法

### 阶段2: 配置系统
- [ ] 理解TOML格式
- [ ] 会使用dataclass
- [ ] 理解配置加载流程
- [ ] 会修改配置文件

### 阶段3: AI运行时
- [ ] 理解AIClient架构
- [ ] 知道如何调用AI API
- [ ] 理解工具调用机制
- [ ] 会创建简单工具

### 阶段4: 消息处理
- [ ] 理解OneBot协议
- [ ] 知道WebSocket连接
- [ ] 理解消息处理流程
- [ ] 会添加新命令

### 阶段5: 技能系统
- [ ] 理解工具注册机制
- [ ] 会开发新工具
- [ ] 理解Agent概念
- [ ] 会开发简单Agent

### 阶段6: 存储系统
- [ ] 理解聊天历史存储
- [ ] 知道记忆机制
- [ ] 理解Token统计
- [ ] 会使用存储API

### 阶段7: 工具模块
- [ ] 理解文件IO
- [ ] 会使用日志系统
- [ ] 知道异步操作
- [ ] 会使用工具函数

### 阶段8: 最佳实践
- [ ] 掌握Python进阶特性
- [ ] 理解代码组织
- [ ] 知道性能优化
- [ ] 养成良好习惯

---

## 🎓 学习成就

通过完整学习这个项目,你将获得:

### Python技能
✅ 基础语法
✅ 面向对象编程
✅ 异步编程
✅ 类型提示
✅ 模块化设计
✅ 错误处理

### 实践能力
✅ 配置管理
✅ API调用
✅ 文件IO
✅ 日志记录
✅ 网络编程
✅ 并发处理

### 项目经验
✅ 项目结构设计
✅ 代码组织
✅ 模块开发
✅ 调试技巧
✅ 文档编写

---

**继续努力!你已经迈出了学习Python的第一步!** 🚀

需要继续学习其他模块吗?请告诉我你想深入了解哪个部分!
